<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <changeSet id="01" author="system" context="base">
        <createTable tableName="tenant">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="api_key" type="varchar(255)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="created_at" type="timestamp"/>
        </createTable>
        
        <sql>
            COMMENT ON TABLE tenant IS 'Tenant information table';
        </sql>
    </changeSet>

    <changeSet id="02" author="system" context="base">
        <createTable tableName="rule">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="bigint"/>
            <column name="event_name" type="varchar(255)"/>
            <column name="active" type="boolean"/>
            <column name="condition" type="text"/>
        </createTable>
        
        <sql>
            COMMENT ON TABLE rule IS 'Business rules table';
        </sql>
        
        <createIndex tableName="rule" indexName="idx_rule_lookup" unique="false">
            <column name="tenant_id"/>
            <column name="event_name"/>
            <column name="active"/>
        </createIndex>
    </changeSet>

    <changeSet id="03" author="system" context="base">
        <createTable tableName="webhook_event">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="bigint"/>
            <column name="provider" type="varchar(255)"/>
            <column name="event_name" type="varchar(255)"/>
            <column name="payload" type="text"/>
            <column name="created_at" type="timestamp"/>
        </createTable>
        
        <sql>
            COMMENT ON TABLE webhook_event IS 'Incoming webhook events table';
        </sql>
    </changeSet>

    <changeSet id="04" author="system" context="base">
        <createTable tableName="action">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="rule_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="varchar(50)"/>
            <column name="config_json" type="text"/>
            <column name="max_attempts" type="int" defaultValueNumeric="3"/>
        </createTable>
        
        <addForeignKeyConstraint 
            baseTableName="action" 
            baseColumnNames="rule_id"
            referencedTableName="rule" 
            referencedColumnNames="id"
            constraintName="fk_action_rule"
            onDelete="CASCADE"/>
        
        <sql>
            COMMENT ON TABLE action IS 'Actions to be executed for rules';
        </sql>
    </changeSet>

    <changeSet id="05" author="system" context="base">
        <createTable tableName="action_execution">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="action_id" type="bigint"/>
            <column name="event_id" type="bigint"/>
            <column name="status" type="varchar(50)"/>
            <column name="attempts" type="int" defaultValueNumeric="0"/>
            <column name="next_retry_at" type="timestamp"/>
            <column name="last_error" type="varchar(1000)"/>
            <column name="created_at" type="timestamp"/>
            <column name="updated_at" type="timestamp"/>
        </createTable>
        
        <addForeignKeyConstraint 
            baseTableName="action_execution" 
            baseColumnNames="action_id"
            referencedTableName="action" 
            referencedColumnNames="id"
            constraintName="fk_action_execution_action"
            onDelete="CASCADE"/>
            
        <addForeignKeyConstraint 
            baseTableName="action_execution" 
            baseColumnNames="event_id"
            referencedTableName="webhook_event" 
            referencedColumnNames="id"
            constraintName="fk_action_execution_event"
            onDelete="CASCADE"/>
        
        <sql>
            COMMENT ON TABLE action_execution IS 'Action execution tracking table';
        </sql>
    </changeSet>

    <changeSet id="06" author="system" context="base">
        <createTable tableName="processed_event">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="external_event_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="processed_at" type="timestamp"/>
        </createTable>
        
        <addUniqueConstraint 
            tableName="processed_event"
            columnNames="tenant_id, external_event_id"
            constraintName="uk_processed_event_tenant_external"/>
        
        <sql>
            COMMENT ON TABLE processed_event IS 'Processed events tracking table';
        </sql>
    </changeSet>

</databaseChangeLog>